# C/C++ with GCC
# Build your C/C++ project with GCC using make.
# Add steps that publish test results, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/c-cpp/gcc

# optional make test steps template

parameters:
  options: ''
  package_name: 'default'

steps:
- script: |
    ulimit -a
    ulimit -c unlimited
    cat /proc/sys/kernel/core_pattern
    sudo sysctl -w kernel.core_pattern=core/core.%e.%p
    cat /proc/sys/kernel/core_pattern
  displayName: 'setup'
  condition: eq(variables['Agent.OS'], 'Linux')
- script: make -C test showcxxversion
  displayName: 'versions'
- script: make -C test -j4 OUTPUTXML=junit ${{ parameters.options }}
  displayName: 'make'
- script: make -C test OUTPUTXML=junit ${{ parameters.options }} ${run_option} test
  displayName: 'test'
  env:
    run_option: RUN_OPTION="--iutest_default_package_name=${{ parameters.package_name }}"
- script: ls -a && cd test && ls -a
  displayName: 'failed check'
  condition: failed()
- task: PublishPipelineArtifact@0
  condition: failed()
  inputs:
    artifactName: 'test'
    targetPath: 'test'

- task: PublishTestResults@2
  inputs:
    testResultsFiles: 'test/*.xml'
